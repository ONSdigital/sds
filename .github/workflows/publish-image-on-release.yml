name: Release Workflow

on:
  push:
    tag:
      - 'v*' #Match tags starting with 'v'

jobs:
  docker-push:
      runs-on: ubuntu-22.04
      steps:
        - uses: actions/checkout@v3

        - name: Get Release Tag
          id: get_release_tag
          run: echo "Release Tag ${{ github.ref }}"

        - name: Extract Tag Name
          id: extract_tag_name
          run: echo "Tag Name ${GITHUB_REF##*/}" #This extracts tag name from the full reference.

        - name: Set Tag Name variable
          run: |
            TAG_NAME="${{ steps.extract_tag_name.outputs.stdout }}"

        - name: Write app version
          run: printf "$GITHUB_SHA" > .application-version
        - name: Build
          run: >
            docker build -t onsdigital/sds:$TAG_NAME .
        - name: Push to Docker Hub
          run: |
            echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            echo "Pushing with tag [$TAG_NAME]"
            docker push onsdigital/sds:$TAG_NAME
